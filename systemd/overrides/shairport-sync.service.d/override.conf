[Unit]
Requires=airplay-wyse-identity.service
After=network-online.target airplay-wyse-identity.service
Requires=nqptp.service
After=nqptp.service

[Service]
Restart=on-failure
RestartSec=2s
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
PrivateTmp=true
MemoryDenyWriteExecute=yes
RestrictAddressFamilies=AF_UNIX AF_INET AF_INET6
SystemCallFilter=@system-service
SystemCallFilter=~@privileged @resources
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_BIND_SERVICE
ExecStartPre=/bin/sh -c '\\
  conf=/etc/shairport-sync.conf; \\
  mac=$(awk \''BEGIN{IGNORECASE=1} /hardware_address[[:space:]]*=/{match($0,/=[[:space:]]*"[^"]+"/); if(RSTART>0){v=substr($0,RSTART+2,RLENGTH-2); gsub(/^[ \\t\\"]+|[ \\t\\"]+$/, "", v); print v; exit}}'\'' "$conf" 2>/dev/null); \\
  case "${mac}" in \\
    ""|"00:00:00:00:00:00") \\
      echo "shairport-sync: hardware_address missing/zero in $conf; run /usr/local/libexec/airplay_wyse/identity-ensure" >&2; \\
      exit 1 ;; \\
    *) exit 0 ;; \\
  esac'
