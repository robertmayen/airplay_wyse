[Unit]
Requires=airplay-wyse-identity.service
After=network-online.target airplay-wyse-identity.service
Requires=nqptp.service
After=nqptp.service
Wants=avahi-daemon.service
After=avahi-daemon.service

[Service]
Restart=on-failure
RestartSec=2s
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
PrivateTmp=true
MemoryDenyWriteExecute=yes
RestrictAddressFamilies=AF_UNIX AF_INET AF_INET6
SystemCallFilter=@system-service
SystemCallFilter=~@privileged @resources
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_BIND_SERVICE
# Guard: require non-zero AirPlay 2 device id before starting Shairport.
# "After=" is ordering only; "Requires=" enforces dependency start (systemd.unit docs).
# References:
#  - https://www.freedesktop.org/software/systemd/man/latest/systemd.unit.html
ExecStartPre=/bin/sh -c '\\
  conf=/etc/shairport-sync.conf; \\
  val=$(awk \''BEGIN{IGNORECASE=1} /airplay_device_id[[:space:]]*=/{match($0,/=[[:space:]]*[^;]+;/); if(RSTART>0){v=substr($0,RSTART+1,RLENGTH-2); gsub(/^[ \\t]+|[ \\t]+$/, "", v); print v; exit}}'\'' "$conf" 2>/dev/null); \\
  up=$(printf "%s" "$val" | tr a-z A-Z | tr -d ' '); \\
  case "${up}" in \\
    ""|"0"|"0X0L"|"0X000000000000L") \\
      echo "shairport-sync: airplay_device_id missing/zero in $conf; run /usr/local/libexec/airplay_wyse/identity-ensure" >&2; \\
      exit 1 ;; \\
    *) exit 0 ;; \\
  esac'
ExecStartPre=/usr/local/libexec/airplay_wyse/preflight-alsa
