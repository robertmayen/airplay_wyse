#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="/opt/airplay_wyse"

log() { printf '%s [reconcile] %s\n' "$(date -u +%Y-%m-%dT%H:%M:%SZ)" "$*"; }

main() {
  if [[ "$(id -un)" != "airplay" ]]; then
    echo "This service must run as user 'airplay'" >&2
    exit 1
  fi
  cd "$REPO_DIR"
  log "Starting reconcile"
  # Update to target tag (bin/update verifies and checks out)
  "$REPO_DIR/bin/update"
  # Run converge (idempotent; performs ALSA detect, config deploy, package ensure, health)
  "$REPO_DIR/bin/converge"
}

main "$@"
