#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="/opt/airplay_wyse"

log() { printf '%s [reconcile] %s\n' "$(date -u +%Y-%m-%dT%H:%M:%SZ)" "$*"; }

main() {
  # Root-run model: service runs as root with systemd hardening
  cd "$REPO_DIR"
  log "Starting reconcile"
  # Update to target tag (bin/update verifies and checks out)
  "$REPO_DIR/bin/update"
  # Run converge (idempotent; performs ALSA detect, config deploy, package ensure, health)
  "$REPO_DIR/bin/converge"
}

main "$@"
