#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")"/.. && pwd)"
STATE_DIR="/var/lib/airplay_wyse"

bootstrap_ok=null
pkg_profile_ok=null

# shellcheck disable=SC1091
. "$REPO_DIR/lib/bootstrap.sh" >/dev/null 2>&1 || true

if command -v sudo >/dev/null 2>&1; then
  if is_bootstrapped; then bootstrap_ok=true; else bootstrap_ok=false; fi
fi

# Test pkg profile with a no-op if wrapper exists
if [[ -x /usr/local/sbin/airplay-sd-run ]]; then
  if /usr/local/sbin/airplay-sd-run pkg-ensure -- /bin/true >/dev/null 2>&1; then
    pkg_profile_ok=true
  else
    pkg_profile_ok=false
  fi
fi

if [[ -f "$STATE_DIR/last-health.json" ]]; then
  jq --argjson bootstrap "$bootstrap_ok" --argjson pkgprofile "$pkg_profile_ok" \
     '. + {bootstrap_ok:$bootstrap, pkg_profile_ok:$pkgprofile}' "$STATE_DIR/last-health.json" 2>/dev/null \
     || cat "$STATE_DIR/last-health.json"
else
  printf '{"status":"unknown","reason":"no prior converge","bootstrap_ok":%s,"pkg_profile_ok":%s}\n' \
    "${bootstrap_ok:-null}" "${pkg_profile_ok:-null}"
fi
