#!/usr/bin/env bash
set -euo pipefail

# Minimal diagnostics collector for AirPlay Wyse

echo "=== AirPlay Wyse Diagnostics ==="
echo "Date: $(date --iso-8601=seconds)"
echo "Host: $(hostname -f)"
echo ""

echo "=== Version ==="
cat /opt/airplay_wyse/VERSION 2>/dev/null || echo "VERSION file not found"
echo ""

echo "=== Git Status ==="
if command -v git >/dev/null 2>&1; then
  cd /opt/airplay_wyse 2>/dev/null && git describe --tags --always 2>/dev/null || echo "Not in git repo"
else
  echo "git not installed"
fi
echo ""

echo "=== Shairport-sync ==="
if command -v shairport-sync >/dev/null 2>&1; then
  shairport-sync -V 2>&1 | head -1
  systemctl is-active shairport-sync 2>/dev/null || echo "Service not active"
else
  echo "shairport-sync not installed"
fi
echo ""

echo "=== NQPTP ==="
if systemctl list-unit-files --type=service --no-legend 2>/dev/null | grep -q "^nqptp.service"; then
  systemctl is-active nqptp 2>/dev/null || echo "nqptp not active"
else
  echo "nqptp service not found"
fi
echo ""

echo "=== ALSA Device ==="
if [[ -x /opt/airplay_wyse/bin/alsa-probe ]]; then
  /opt/airplay_wyse/bin/alsa-probe 2>/dev/null || echo "No ALSA device found"
else
  echo "alsa-probe not found"
fi
echo ""

echo "=== mDNS Advertisement ==="
if command -v avahi-browse >/dev/null 2>&1; then
  echo -n "_airplay._tcp: "
  timeout 5 avahi-browse -rt _airplay._tcp 2>/dev/null | grep -q "_airplay._tcp" && echo "visible" || echo "not visible"
  echo -n "_raop._tcp: "
  timeout 5 avahi-browse -rt _raop._tcp 2>/dev/null | grep -q "_raop._tcp" && echo "visible" || echo "not visible"
else
  echo "avahi-browse not installed"
fi
echo ""

echo "=== Last Health ==="
if [[ -f /var/lib/airplay_wyse/last-health.json ]]; then
  cat /var/lib/airplay_wyse/last-health.json 2>/dev/null | jq . 2>/dev/null || cat /var/lib/airplay_wyse/last-health.json
else
  echo "No health data found"
fi
echo ""

echo "=== Recent Logs ==="
journalctl -u shairport-sync -n 20 --no-pager 2>/dev/null || echo "No shairport logs available"
journalctl -u nqptp -n 20 --no-pager 2>/dev/null || echo "No nqptp logs available"
