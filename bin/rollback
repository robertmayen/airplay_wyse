#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")"/.. && pwd)"

usage() {
  echo "Usage: $0 <signed-tag>"
}

tag="${1:-}"
if [[ -z "$tag" ]]; then
  usage
  exit 1
fi

if ! command -v git >/dev/null; then
  echo "git not found"
  exit 1
fi

if ! git -C "$REPO_DIR" verify-tag "$tag"; then
  echo "Tag verification failed: $tag"
  exit 1
fi

git -C "$REPO_DIR" checkout -f "$tag"
exec "$REPO_DIR/bin/converge"
